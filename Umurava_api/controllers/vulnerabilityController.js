const prisma = require("../config/database");

const VulnerabilityController = {
    async submitReports(req, res) {
        try {
            console.log("üöÄ Backend: Vulnerability reports submission request");
            console.log("üì§ Backend: Request body:", req.body);
            console.log("üë§ Backend: User from auth middleware:", req.user);
            
            const { challengeId, reports } = req.body;
            
            if (!challengeId || !reports || !Array.isArray(reports)) {
                return res.status(400).json({ 
                    message: "Challenge ID and reports array are required" 
                });
            }

            if (reports.length === 0) {
                return res.status(400).json({ 
                    message: "At least one vulnerability report is required" 
                });
            }

            // Create vulnerability reports in database
            const createdReports = [];
            
            for (const report of reports) {
                const vulnerabilityReport = await prisma.vulnerabilityReport.create({
                    data: {
                        challengeId,
                        userId: req.user.id,
                        title: report.title,
                        severity: report.severity,
                        category: report.category || null,
                        description: report.description,
                        stepsToReproduce: report.stepsToReproduce || null,
                        impact: report.impact || null,
                        recommendation: report.recommendation || null,
                        evidence: report.evidence || null,
                        status: 'submitted'
                    }
                });
                createdReports.push(vulnerabilityReport);
            }

            console.log(`‚úÖ Backend: Successfully created ${createdReports.length} vulnerability reports`);
            
            res.status(201).json({
                message: `Successfully submitted ${createdReports.length} vulnerability report(s)`,
                reports: createdReports
            });
        } catch (error) {
            console.error("‚ùå Backend: Error submitting vulnerability reports:", error);
            console.error("‚ùå Backend: Error stack:", error.stack);
            res.status(500).json({ 
                message: "Error submitting vulnerability reports", 
                error: error.message 
            });
        }
    },

    async getReportsByChallenge(req, res) {
        try {
            const { challengeId } = req.params;
            
            const reports = await prisma.vulnerabilityReport.findMany({
                where: {
                    challengeId,
                    userId: req.user.id
                },
                orderBy: {
                    createdAt: 'desc'
                }
            });

            res.status(200).json(reports);
        } catch (error) {
            console.error("‚ùå Backend: Error fetching vulnerability reports:", error);
            res.status(500).json({ 
                message: "Error fetching vulnerability reports", 
                error: error.message 
            });
        }
    },

    async getAllUserReports(req, res) {
        try {
            const reports = await prisma.vulnerabilityReport.findMany({
                where: {
                    userId: req.user.id
                },
                include: {
                    challenge: {
                        select: {
                            title: true
                        }
                    }
                },
                orderBy: {
                    createdAt: 'desc'
                }
            });

            res.status(200).json(reports);
        } catch (error) {
            console.error("‚ùå Backend: Error fetching user vulnerability reports:", error);
            res.status(500).json({ 
                message: "Error fetching user vulnerability reports", 
                error: error.message 
            });
        }
    }
};

module.exports = VulnerabilityController;