const API_BASE_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:5000/api';

export interface VulnerabilityReport {
  title: string;
  severity: 'critical' | 'high' | 'medium' | 'low' | 'info';
  category: string;
  description: string;
  stepsToReproduce: string;
  impact: string;
  recommendation: string;
  evidence: string;
}

export interface VulnerabilitySubmission {
  challengeId: string;
  reports: VulnerabilityReport[];
}

export const vulnerabilityService = {
  async submitReports(submission: VulnerabilitySubmission): Promise<any> {
    const token = localStorage.getItem('token');
    
    if (!token) {
      throw new Error('No authentication token found');
    }

    console.log('üöÄ Frontend: Submitting vulnerability reports:', submission);

    const response = await fetch(`${API_BASE_URL}/vulnerabilities/submit`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`,
      },
      body: JSON.stringify(submission),
    });

    if (!response.ok) {
      let error;
      try {
        error = await response.json();
      } catch {
        error = { message: `HTTP ${response.status}: ${response.statusText}` };
      }
      console.error("‚ùå Frontend: Submit vulnerability reports error:", error);
      throw new Error(error.message || 'Failed to submit vulnerability reports');
    }

    const result = await response.json();
    console.log('‚úÖ Frontend: Vulnerability reports submitted successfully:', result);
    return result;
  },

  async getReportsByChallenge(challengeId: string): Promise<any[]> {
    const token = localStorage.getItem('token');
    
    if (!token) {
      throw new Error('No authentication token found');
    }

    const response = await fetch(`${API_BASE_URL}/vulnerabilities/challenge/${challengeId}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
      },
    });

    if (!response.ok) {
      let error;
      try {
        error = await response.json();
      } catch {
        error = { message: `HTTP ${response.status}: ${response.statusText}` };
      }
      console.error("‚ùå Frontend: Get vulnerability reports error:", error);
      throw new Error(error.message || 'Failed to fetch vulnerability reports');
    }

    return await response.json();
  },

  async getAllUserReports(): Promise<any[]> {
    const token = localStorage.getItem('token');
    
    if (!token) {
      throw new Error('No authentication token found');
    }

    const response = await fetch(`${API_BASE_URL}/vulnerabilities/user`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
      },
    });

    if (!response.ok) {
      let error;
      try {
        error = await response.json();
      } catch {
        error = { message: `HTTP ${response.status}: ${response.statusText}` };
      }
      console.error("‚ùå Frontend: Get user vulnerability reports error:", error);
      throw new Error(error.message || 'Failed to fetch user vulnerability reports');
    }

    return await response.json();
  }
};